import React, { useEffect, useMemo, useState } from "react";

/**
 * Sebenza Hub – Interview Booking
 * Single-file React component (default export) suitable for embedding in your app.
 *
 * What it does
 * - Lets a candidate pick provider (Google Meet / Teams / Zoom), interviewer email, date & time
 * - Pulls availability from your /api/availability endpoint
 * - Books the interview via /api/book endpoint
 * - Handles time zones and basic validation
 *
 * Styling
 * - TailwindCSS utility classes
 * - Minimal dependencies; vanilla React
 *
 * Backend assumptions (as per earlier snippets)
 * - GET /api/availability?provider=google|microsoft&email=...&from=ISO&to=ISO
 *   -> returns an array of busy windows [{ start, end } | scheduleItems]
 * - POST /api/book { provider, token, interviewer, candidate, start, end, title }
 *   -> returns { link }
 */

// ---------- Helpers ----------

const PROVIDERS = [
  { key: "google", label: "Google Meet" },
  { key: "microsoft", label: "Microsoft Teams" },
  { key: "zoom", label: "Zoom" },
] as const;

type ProviderKey = typeof PROVIDERS[number]["key"]; 

function toISO(dt: Date) {
  return dt.toISOString();
}

function addMinutes(date: Date, mins: number) {
  return new Date(date.getTime() + mins * 60000);
}

function formatLocal(dt: Date, timeZone?: string) {
  return new Intl.DateTimeFormat(undefined, {
    dateStyle: "medium",
    timeStyle: "short",
    timeZone,
  }).format(dt);
}

function sameDay(a: Date, b: Date) {
  return (
    a.getFullYear() === b.getFullYear() &&
    a.getMonth() === b.getMonth() &&
    a.getDate() === b.getDate()
  );
}

// Build a list of candidate slots given working hours and busy blocks
function buildSlots(
  day: Date,
  {
    startHour = 9,
    endHour = 17,
    intervalMins = 30,
    durationMins = 60,
    bufferMins = 10,
  }: {
    startHour?: number;
    endHour?: number;
    intervalMins?: number;
    durationMins?: number;
    bufferMins?: number;
  },
  busy: { start: string; end: string }[]
): { start: Date; end: Date }[] {
  const dayStart = new Date(day);
  dayStart.setHours(startHour, 0, 0, 0);
  const dayEnd = new Date(day);
  dayEnd.setHours(endHour, 0, 0, 0);

  const slots: { start: Date; end: Date }[] = [];
  for (let t = new Date(dayStart); t < dayEnd; t = addMinutes(t, intervalMins)) {
    const start = new Date(t);
    const end = addMinutes(start, durationMins);
    if (end > dayEnd) break;

    // apply buffer by expanding busy windows
    const overlaps = busy.some(({ start: bs, end: be }) => {
      const bsDate = new Date(bs);
      const beDate = new Date(be);
      const bsBuffered = addMinutes(bsDate, -bufferMins);
      const beBuffered = addMinutes(beDate, bufferMins);
      return start < beBuffered && end > bsBuffered;
    });

    if (!overlaps) slots.push({ start, end });
  }
  return slots;
}

// Normalize Google FreeBusy response to [{start, end}]
function normalizeBusy(provider: ProviderKey, payload: any, email: string) {
  if (provider === "google") {
    const fb = payload?.calendars?.[email]?.busy || [];
    return fb.map((b: any) => ({ start: b.start, end: b.end }));
  }
  if (provider === "microsoft") {
    // Graph getSchedule returns value[0].scheduleItems
    const items = payload?.value?.[0]?.scheduleItems || [];
    return items.map((i: any) => ({ start: i.start.dateTime, end: i.end.dateTime }));
  }
  return [];
}

// ---------- Component ----------

export default function InterviewBooking() {
  const [provider, setProvider] = useState<ProviderKey>("google");
  const [interviewerEmail, setInterviewerEmail] = useState("");
  const [candidateName, setCandidateName] = useState("");
  const [candidateEmail, setCandidateEmail] = useState("");
  const [candidatePhone, setCandidatePhone] = useState("");
  const [title, setTitle] = useState("Interview with Sebenza Hub");
  const [tz, setTz] = useState<string>(Intl.DateTimeFormat().resolvedOptions().timeZone || "Africa/Johannesburg");

  const [selectedDay, setSelectedDay] = useState<Date>(() => {
    const d = new Date();
    d.setHours(0, 0, 0, 0);
    return d;
  });

  const [busy, setBusy] = useState<{ start: string; end: string }[]>([]);
  const [slots, setSlots] = useState<{ start: Date; end: Date }[]>([]);
  const [intervalMins, setIntervalMins] = useState(30);
  const [durationMins, setDurationMins] = useState(60);
  const [loadingAvail, setLoadingAvail] = useState(false);
  const [booking, setBooking] = useState(false);
  const [bookedLink, setBookedLink] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  const windowFrom = useMemo(() => {
    const start = new Date(selectedDay);
    start.setHours(0, 0, 0, 0);
    return start;
  }, [selectedDay]);

  const windowTo = useMemo(() => {
    const end = new Date(selectedDay);
    end.setHours(23, 59, 59, 999);
    return end;
  }, [selectedDay]);

  // Fetch availability when provider, interviewer, or day changes
  useEffect(() => {
    let ignore = false;
    async function load() {
      setBookedLink(null);
      setError(null);
      setSlots([]);
      if (!interviewerEmail) return;
      setLoadingAvail(true);
      try {
        const params = new URLSearchParams({
          provider,
          email: interviewerEmail,
          from: toISO(windowFrom),
          to: toISO(windowTo),
        });
        const res = await fetch(`/api/availability?${params.toString()}`);
        if (!res.ok) throw new Error(`Availability failed (${res.status})`);
        const payload = await res.json();
        const normalized = normalizeBusy(provider, payload, interviewerEmail);
        if (!ignore) setBusy(normalized);
      } catch (e: any) {
        if (!ignore) setError(e.message || "Failed to load availability");
      } finally {
        if (!ignore) setLoadingAvail(false);
      }
    }
    load();
    return () => { ignore = true; };
  }, [provider, interviewerEmail, windowFrom, windowTo]);

  // Build slots after busy loads or settings change
  useEffect(() => {
    const s = buildSlots(selectedDay, { intervalMins, durationMins }, busy);
    setSlots(s);
  }, [busy, selectedDay, intervalMins, durationMins]);

  const [selectedSlot, setSelectedSlot] = useState<{ start: Date; end: Date } | null>(null);

  async function onBook() {
    setError(null);
    setBookedLink(null);

    // Basic validations
    if (!interviewerEmail) return setError("Please provide an interviewer email.");
    if (!candidateName || !candidateEmail) return setError("Please enter your name and email.");
    if (!selectedSlot) return setError("Please select a time slot.");

    setBooking(true);
    try {
      const body = {
        provider,
        token: "<ACCESS_TOKEN_SERVER_SIDE>", // If booking as organizer with delegated auth, your server should resolve token from DB
        interviewer: { email: interviewerEmail },
        candidate: { name: candidateName, email: candidateEmail, phone: candidatePhone },
        start: selectedSlot.start.toISOString(),
        end: selectedSlot.end.toISOString(),
        title,
        timezone: tz,
      };

      const res = await fetch("/api/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!res.ok) throw new Error(`Booking failed (${res.status})`);
      const payload = await res.json();
      setBookedLink(payload.link || null);
    } catch (e: any) {
      setError(e.message || "Failed to book interview");
    } finally {
      setBooking(false);
    }
  }

  // Simple 7-day date picker (Today + next 6)
  const days = useMemo(() => {
    const out: Date[] = [];
    const base = new Date();
    base.setHours(0, 0, 0, 0);
    for (let i = 0; i < 7; i++) {
      const d = new Date(base);
      d.setDate(base.getDate() + i);
      out.push(d);
    }
    return out;
  }, []);

  return (
    <div className="max-w-3xl mx-auto p-6">
      <div className="mb-6">
        <h1 className="text-2xl font-semibold tracking-tight">Book your interview</h1>
        <p className="text-sm text-gray-500 mt-1">Time zone: <span className="font-medium">{tz}</span></p>
      </div>

      {/* Provider + Interviewer */}
      <div className="grid md:grid-cols-2 gap-4 mb-6">
        <div>
          <label className="block text-sm font-medium mb-1">Video platform</label>
          <div className="flex gap-2">
            {PROVIDERS.map(p => (
              <button
                key={p.key}
                onClick={() => setProvider(p.key)}
                className={`px-3 py-2 rounded-xl border text-sm ${provider===p.key?"bg-gray-900 text-white border-gray-900":"bg-white border-gray-300"}`}
              >{p.label}</button>
            ))}
          </div>
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">Interviewer email</label>
          <input
            value={interviewerEmail}
            onChange={(e) => setInterviewerEmail(e.target.value)}
            placeholder="recruiter@company.com"
            className="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-800"
          />
        </div>
      </div>

      {/* Candidate details */}
      <div className="grid md:grid-cols-3 gap-4 mb-6">
        <div className="md:col-span-1">
          <label className="block text-sm font-medium mb-1">Your name</label>
          <input
            value={candidateName}
            onChange={(e) => setCandidateName(e.target.value)}
            className="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-800"
          />
        </div>
        <div className="md:col-span-1">
          <label className="block text-sm font-medium mb-1">Your email</label>
          <input
            value={candidateEmail}
            onChange={(e) => setCandidateEmail(e.target.value)}
            className="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-800"
          />
        </div>
        <div className="md:col-span-1">
          <label className="block text-sm font-medium mb-1">Phone (optional)</label>
          <input
            value={candidatePhone}
            onChange={(e) => setCandidatePhone(e.target.value)}
            className="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-800"
          />
        </div>
      </div>

      {/* Title + Duration */}
      <div className="grid md:grid-cols-3 gap-4 mb-6">
        <div className="md:col-span-2">
          <label className="block text-sm font-medium mb-1">Meeting title</label>
          <input
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            className="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-800"
          />
        </div>
        <div className="md:col-span-1">
          <label className="block text-sm font-medium mb-1">Duration (mins)</label>
          <select
            value={durationMins}
            onChange={(e) => setDurationMins(parseInt(e.target.value))}
            className="w-full border rounded-xl px-3 py-2"
          >
            {[30, 45, 60, 90].map(v => <option key={v} value={v}>{v}</option>)}
          </select>
        </div>
      </div>

      {/* Date picker */}
      <div className="mb-4">
        <label className="block text-sm font-medium mb-2">Select a day</label>
        <div className="flex gap-2 overflow-x-auto pb-2">
          {days.map(d => (
            <button
              key={d.toISOString()}
              onClick={() => setSelectedDay(d)}
              className={`px-3 py-2 rounded-xl border min-w-[8rem] text-sm text-left ${sameDay(d, selectedDay)?"bg-gray-900 text-white border-gray-900":"bg-white border-gray-300"}`}
            >
              <div className="font-medium">{new Intl.DateTimeFormat(undefined, { weekday: "short" }).format(d)}</div>
              <div className="opacity-80">{new Intl.DateTimeFormat(undefined, { month: "short", day: "numeric" }).format(d)}</div>
            </button>
          ))}
        </div>
      </div>

      {/* Slots */}
      <div className="mb-6">
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium">Available time slots</label>
          <div className="text-xs text-gray-500">Interval
            <select
              value={intervalMins}
              onChange={(e) => setIntervalMins(parseInt(e.target.value))}
              className="ml-2 border rounded-lg px-2 py-1"
            >
              {[15, 30, 45, 60].map(v => <option key={v} value={v}>{v} min</option>)}
            </select>
          </div>
        </div>

        <div className="border rounded-2xl p-3">
          {loadingAvail ? (
            <div className="p-6 text-center text-gray-500">Loading availability…</div>
          ) : slots.length === 0 ? (
            <div className="p-6 text-center text-gray-500">No slots available for this day.</div>
          ) : (
            <div className="grid sm:grid-cols-2 md:grid-cols-3 gap-2">
              {slots.map((s) => (
                <button
                  key={s.start.toISOString()}
                  onClick={() => setSelectedSlot(s)}
                  className={`px-3 py-2 text-sm rounded-xl border ${selectedSlot?.start.getTime()===s.start.getTime()?"bg-gray-900 text-white border-gray-900":"bg-white border-gray-300"}`}
                  title={`${formatLocal(s.start, tz)} – ${formatLocal(s.end, tz)}`}
                >
                  {new Intl.DateTimeFormat(undefined, { hour: "2-digit", minute: "2-digit" }).format(s.start)}
                  <span className="opacity-60"> → </span>
                  {new Intl.DateTimeFormat(undefined, { hour: "2-digit", minute: "2-digit" }).format(s.end)}
                </button>
              ))}
            </div>
          )}
        </div>
      </div>

      {error && (
        <div className="mb-4 p-3 rounded-xl bg-red-50 text-red-800 text-sm border border-red-200">{error}</div>
      )}

      {bookedLink ? (
        <div className="p-4 rounded-xl bg-green-50 border border-green-200">
          <div className="font-medium">Interview booked!</div>
          <div className="text-sm mt-1">Join link: <a href={bookedLink} className="underline" target="_blank" rel="noreferrer">{bookedLink}</a></div>
        </div>
      ) : (
        <button
          onClick={onBook}
          disabled={booking}
          className="w-full md:w-auto px-5 py-3 rounded-xl bg-gray-900 text-white hover:opacity-90 disabled:opacity-50"
        >
          {booking ? "Booking…" : "Book interview"}
        </button>
      )}

      <p className="text-xs text-gray-500 mt-4">
        By booking you agree to be contacted on the details provided. Times are shown in your local time zone.
      </p>
    </div>
  );
}
