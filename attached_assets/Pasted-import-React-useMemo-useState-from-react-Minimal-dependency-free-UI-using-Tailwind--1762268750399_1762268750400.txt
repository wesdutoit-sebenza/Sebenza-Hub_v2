import React, { useMemo, useState } from "react";

// Minimal, dependency-free UI using Tailwind. Fits into your existing modal.
// Drop <WeightsQuestionsTime /> into your "AI Generate" modal body.
// Props `onChange` gives you a clean JSON payload to persist.

export default function WeightsQuestionsTime() {
  // Defaults requested by Wes
  const [weights, setWeights] = useState({ skills: 50, aptitude: 30, workstyle: 20 });
  const [questions, setQuestions] = useState({ skills: 12, aptitude: 8, workstyle: 12 });
  const [time, setTime] = useState({ skills: 25, aptitude: 15, workstyle: 10 }); // minutes

  const totalWeight = weights.skills + weights.aptitude + weights.workstyle;
  const totalQuestions = questions.skills + questions.aptitude + questions.workstyle;
  const totalTime = time.skills + time.aptitude + time.workstyle;

  const weightStatus = useMemo(() => {
    if (totalWeight > 100) return { ok: false, msg: `Total weights ${totalWeight}% exceeds 100%` };
    if (totalWeight < 100) return { ok: true, msg: `Total weights ${totalWeight}% (Remaining ${100 - totalWeight}%)` };
    return { ok: true, msg: "Total weights = 100%" };
  }, [totalWeight]);

  const payload = useMemo(() => ({
    weights,
    questions,
    time,
    totals: { questions: totalQuestions, timeMin: totalTime, weightPct: totalWeight },
  }), [weights, questions, time, totalQuestions, totalTime, totalWeight]);

  const updateWeight = (k: keyof typeof weights, v: number) => setWeights((w) => ({ ...w, [k]: clamp(v, 0, 100) }));
  const updateQuestions = (k: keyof typeof questions, v: number) => setQuestions((q) => ({ ...q, [k]: clamp(v, 0, 100) }));
  const updateTime = (k: keyof typeof time, v: number) => setTime((t) => ({ ...t, [k]: clamp(v, 0, 240) }));

  const handleAutoBalance = () => {
    // Evenly distribute remaining (or trim proportionally) to hit exactly 100%
    const current = [weights.skills, weights.aptitude, weights.workstyle];
    const sum = current.reduce((a, b) => a + b, 0);
    if (sum === 100) return;
    if (sum === 0) {
      setWeights({ skills: 34, aptitude: 33, workstyle: 33 });
      return;
    }
    // Scale to 100
    const scaled = current.map((v) => (v / sum) * 100);
    // Avoid float noise
    const s = Math.round(scaled[0]);
    const a = Math.round(scaled[1]);
    let w = 100 - s - a; // force sum to 100
    setWeights({ skills: s, aptitude: a, workstyle: w });
  };

  const handleGenerate = () => {
    if (totalWeight > 100) return; // guard
    // Send to parent / API as needed. For demo we log.
    console.log("ASSESSMENT CONFIG", payload);
    // TODO: call your blueprint generator with this payload merged into meta
  };

  return (
    <div className="space-y-6">
      {/* Weights */}
      <section className="rounded-2xl border border-neutral-200/60 bg-neutral-50 p-4">
        <div className="flex items-center justify-between">
          <h3 className="text-base font-semibold">Section Weights</h3>
          <div className={`text-sm ${weightStatus.ok ? "text-neutral-600" : "text-red-600"}`}>
            {weightStatus.msg}
          </div>
        </div>
        <p className="mt-1 text-sm text-neutral-600">Defaults Skills: 50% · Aptitude: 30% · Work‑Style: 20%. You can adjust; total must not exceed 100%.</p>

        <div className="mt-4 grid gap-4 md:grid-cols-3">
          <WeightSlider
            label="Skills"
            value={weights.skills}
            onChange={(v) => updateWeight("skills", v)}
          />
          <WeightSlider
            label="Aptitude"
            value={weights.aptitude}
            onChange={(v) => updateWeight("aptitude", v)}
          />
          <WeightSlider
            label="Work‑Style"
            value={weights.workstyle}
            onChange={(v) => updateWeight("workstyle", v)}
          />
        </div>

        <div className="mt-3 flex items-center justify-between">
          <div className="text-sm text-neutral-700">Total: <span className="font-semibold">{totalWeight}%</span></div>
          <button type="button" onClick={handleAutoBalance} className="rounded-xl bg-neutral-900 px-3 py-2 text-sm text-white hover:bg-neutral-800">Auto-balance to 100%</button>
        </div>
      </section>

      {/* Questions */}
      <section className="rounded-2xl border border-neutral-200/60 bg-neutral-50 p-4">
        <h3 className="text-base font-semibold">Number of Questions</h3>
        <p className="mt-1 text-sm text-neutral-600">Adjust questions per section. Keep it short for mobile.</p>
        <div className="mt-4 grid gap-4 md:grid-cols-3">
          <CountInput label="Skills" value={questions.skills} min={0} max={100} onChange={(v) => updateQuestions("skills", v)} />
          <CountInput label="Aptitude" value={questions.aptitude} min={0} max={100} onChange={(v) => updateQuestions("aptitude", v)} />
          <CountInput label="Work‑Style" value={questions.workstyle} min={0} max={100} onChange={(v) => updateQuestions("workstyle", v)} />
        </div>
        <div className="mt-3 text-sm text-neutral-700">Total Questions: <span className="font-semibold">{totalQuestions}</span></div>
      </section>

      {/* Time */}
      <section className="rounded-2xl border border-neutral-200/60 bg-neutral-50 p-4">
        <h3 className="text-base font-semibold">Time Allocation (minutes)</h3>
        <p className="mt-1 text-sm text-neutral-600">Defaults Skills: 25 · Aptitude: 15 · Work‑Style: 10</p>
        <div className="mt-4 grid gap-4 md:grid-cols-3">
          <TimeInput label="Skills" value={time.skills} min={0} max={240} onChange={(v) => updateTime("skills", v)} />
          <TimeInput label="Aptitude" value={time.aptitude} min={0} max={240} onChange={(v) => updateTime("aptitude", v)} />
          <TimeInput label="Work‑Style" value={time.workstyle} min={0} max={240} onChange={(v) => updateTime("workstyle", v)} />
        </div>
        <div className="mt-3 text-sm text-neutral-700">Total Time: <span className="font-semibold">{totalTime} min</span></div>
      </section>

      <footer className="flex items-center justify-between">
        <div className="text-xs text-neutral-600">Tip: If weights don’t add to 100%, we’ll proportionally scale them on generate.</div>
        <button
          type="button"
          disabled={totalWeight > 100}
          onClick={handleGenerate}
          className={`rounded-xl px-4 py-2 text-sm font-semibold text-white ${totalWeight > 100 ? "bg-neutral-400" : "bg-amber-600 hover:bg-amber-700"}`}
        >
          Generate Test
        </button>
      </footer>

      {/* Debug / integration surface */}
      <pre className="mt-4 max-h-48 overflow-auto rounded-xl bg-neutral-900 p-3 text-xs text-neutral-100">{JSON.stringify(payload, null, 2)}</pre>
    </div>
  );
}

function WeightSlider({ label, value, onChange }: { label: string; value: number; onChange: (v: number) => void }) {
  return (
    <div className="rounded-xl bg-white p-3 shadow-sm ring-1 ring-neutral-200">
      <div className="mb-2 flex items-center justify-between">
        <span className="text-sm font-medium text-neutral-800">{label}</span>
        <span className="text-sm tabular-nums text-neutral-700">{value}%</span>
      </div>
      <input
        type="range"
        min={0}
        max={100}
        step={1}
        value={value}
        onChange={(e) => onChange(Number(e.target.value))}
        className="w-full accent-amber-600"
        aria-label={`${label} weight percentage`}
      />
    </div>
  );
}

function CountInput({ label, value, min = 0, max = 100, onChange }: { label: string; value: number; min?: number; max?: number; onChange: (v: number) => void }) {
  return (
    <div className="rounded-xl bg-white p-3 shadow-sm ring-1 ring-neutral-200">
      <label className="mb-1 block text-sm font-medium text-neutral-800">{label}</label>
      <div className="flex items-center gap-2">
        <button type="button" className="rounded-lg bg-neutral-100 px-2 py-1 text-sm" onClick={() => onChange(value - 1)} aria-label={`Decrease ${label} questions`}>
          −
        </button>
        <input
          type="number"
          min={min}
          max={max}
          value={value}
          onChange={(e) => onChange(Number(e.target.value))}
          className="w-full rounded-lg border border-neutral-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500"
          aria-label={`${label} number of questions`}
        />
        <button type="button" className="rounded-lg bg-neutral-100 px-2 py-1 text-sm" onClick={() => onChange(value + 1)} aria-label={`Increase ${label} questions`}>
          +
        </button>
      </div>
    </div>
  );
}

function TimeInput({ label, value, min = 0, max = 240, onChange }: { label: string; value: number; min?: number; max?: number; onChange: (v: number) => void }) {
  return (
    <div className="rounded-xl bg-white p-3 shadow-sm ring-1 ring-neutral-200">
      <label className="mb-1 block text-sm font-medium text-neutral-800">{label}</label>
      <div className="flex items-center gap-2">
        <button type="button" className="rounded-lg bg-neutral-100 px-2 py-1 text-sm" onClick={() => onChange(value - 5)} aria-label={`Decrease ${label} minutes`}>
          −5
        </button>
        <input
          type="number"
          min={min}
          max={max}
          value={value}
          onChange={(e) => onChange(Number(e.target.value))}
          className="w-full rounded-lg border border-neutral-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500"
          aria-label={`${label} time minutes`}
        />
        <button type="button" className="rounded-lg bg-neutral-100 px-2 py-1 text-sm" onClick={() => onChange(value + 5)} aria-label={`Increase ${label} minutes`}>
          +5
        </button>
      </div>
    </div>
  );
}

function clamp(n: number, min: number, max: number) {
  return Math.max(min, Math.min(max, n));
}
